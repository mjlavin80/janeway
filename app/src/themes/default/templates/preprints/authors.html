{% extends "core/base.html" %}
{% load static from staticfiles %}
{% load i18n %}

{% block title %}{% trans "Submit an Article" %}{% endblock title %}

{% block body %}

    <div class="row">
        <div class="col-md-12">
            <h1>{% trans "Author Information" %}</h1>
            {% csrf_token %}
            <hr>
        </div>
    </div>


    <div class="row">
        <div class="col-md-7">
            <h4>{% trans "Search for Existing Authors" %}</h4>
            <form method="POST">
                {% csrf_token %}
                <div class="row">
                    <div class="col-md-12">
                        <p>{% trans "Search for a user using email address or ORCiD. If a user is matched, they will be automatically added as an author. This search only returns exact matches." %}</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-8">
                        <input class="form-control" name="author_search_text" style="width: 100%;" value=""
                               placeholder="{% trans "Search by email address or ORCiD" %}.">
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary" name="search_authors"><i class="fa fa-search">
                            &nbsp;</i>{% trans "Search" %}</button>
                    </div>
                </div>
            </form>
            <hr>
            <h4>Add New Author</h4>
            {% if not user in article.authors.all %}
                <p>{% trans "By default, your account is the owner of this submission, but is not an Author on record. You can add yourself using the button below." %}</p>
                <a class="btn btn-primary"
                   href="{% url 'submit_authors' article.id %}?add_self=True">{% trans "Add Self as Author" %}</a>
            {% endif %}
            <hr>
            <p>{% trans "If you cannot find the author record by searching, and you are not the only author, you can add one by clicking the button below. This will open a popup modal for you to complete their details." %}</p>
            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#author">
                {% trans "Add New Author" %}
            </button>
            {% include "elements/submit/author.html" %}
        </div>

        <div class="col-md-5">
            <h4>{% trans "Current Authors" %}</h4>
            <div class="row">
                <div class="col-md-12">
                    <table class="table table-hover">
                        <thead>
                        <tr>
                            <th></th>
                            <th>{% trans "Name" %}</th>
                            <th>{% trans "Email" %}</th>
                            <th></th>
                        </tr>
                        </thead>
                        <tbody id="sortable">
                        {% for order in article.articleauthororder_set.all %}
                            <tr id="authors-{{ order.author.pk }}">
                                <td><i class="fa fa-sort"></i></td>
                                <td>{{ order.author.full_name }}</td>
                                <td>{{ order.author.email }}</td>
                                <td><a href="{% url 'delete_author' article.pk order.author.pk %}"><i class="fa fa-trash">
                                    &nbsp;</i></a></td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="3">{% trans "No authors yet, add one!" %}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                    <hr/>
                    <form method="POST">
                        {% csrf_token %}
                         <p>{% trans "When you've added all the authors, select Save and Continue to move to the next step of your submission." %}</p>
                        <br/>
                        <button class="btn btn-success pull-right" type="submit" name="start_submission"><i
                                class="fa fa-check">&nbsp;</i>{% trans "Save and Continue" %}</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock body %}

{% block js %}
    {% if modal %}
        <script>
            $('#author').modal('show')
        </script>
    {% endif %}
    <script src="{% static "admin/js/csrf.js" %}"></script>
    <link type='text/css' href="{% static "common/css/jq-ui.css" %}" rel="stylesheet">
    <script type="text/javascript" src="{% static "common/js/jq-ui.min.js" %}"></script>
    <script>
        $( "#sortable" ).sortable({
            update: function (event, ui) {
                var data = $(this).sortable('serialize');
                console.log(data);
                // POST to server using $.post or $.ajax
                $.ajax({
                    data: data,
                    type: 'POST',
                    url: '{% url 'submit_authors' article.pk %}'
                });
            }
        });
        $( "#sortable" ).disableSelection();
    </script>
{% endblock %}